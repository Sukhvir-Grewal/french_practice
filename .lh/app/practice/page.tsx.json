{
    "sourceFile": "app/practice/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1767726896587,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1767726896587,
            "name": "Commit-0",
            "content": "\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { getRandomWords, soundsData } from \"@/lib/sounds-data\";\r\nimport type { Example, Sound } from \"@/lib/sounds-data\";\r\nimport PracticeCard from \"@/components/PracticeCard\";\r\nimport SoundPracticeCard from \"@/components/SoundPracticeCard\";\r\nimport SessionComplete from \"@/components/SessionComplete\";\r\nimport ProgressBar from \"@/components/ProgressBar\";\r\nimport SpeedControl from \"@/components/SpeedControl\";\r\nimport PracticeModeSelector from \"@/components/PracticeModeSelector\";\r\nimport {\r\n  getPlaybackSpeed,\r\n  setPlaybackSpeed,\r\n  savePracticeSession,\r\n} from \"@/lib/progress\";\r\n\r\nexport default function PracticePage() {\r\n  const [practiceMode, setPracticeMode] = useState<'words' | 'sounds'>('words');\r\n  const [words, setWords] = useState<Example[]>([]);\r\n  const [soundsToLearn, setSoundsToLearn] = useState<Sound[]>([]);\r\n  const [currentIndex, setCurrentIndex] = useState(0);\r\n  const [translationRevealed, setTranslationRevealed] = useState(false);\r\n  const [correctCount, setCorrectCount] = useState(0);\r\n  const [sessionComplete, setSessionComplete] = useState(false);\r\n  const [playbackSpeed, setSpeed] = useState(0.8);\r\n  const [autoPlay, setAutoPlay] = useState(false);\r\n  const [sessionStartTime, setSessionStartTime] = useState<number>(Date.now());\r\n  const [continuousMode, setContinuousMode] = useState(false);\r\n  const [lastSpokenText, setLastSpokenText] = useState<string>(\"\");\r\n\r\n  const WORDS_PER_SESSION = 10;\r\n\r\n  // Initialize practice session - runs once on mount and when mode changes\r\n  useEffect(() => {\r\n    // Always generate fresh random data\r\n    if (practiceMode === 'words') {\r\n      const randomWords = getRandomWords(WORDS_PER_SESSION);\r\n      setWords(randomWords);\r\n    } else {\r\n      // For sounds mode, shuffle all sounds with timestamp to ensure uniqueness\r\n      const shuffledSounds = [...soundsData].sort(() => Math.random() - 0.5);\r\n      setSoundsToLearn(shuffledSounds);\r\n    }\r\n    // Load saved speed\r\n    setSpeed(getPlaybackSpeed());\r\n    // Reset state when mode changes\r\n    setCurrentIndex(0);\r\n    setTranslationRevealed(false);\r\n    setCorrectCount(0);\r\n    setSessionComplete(false);\r\n  }, [practiceMode]);\r\n\r\n  // Force fresh data on component mount\r\n  useEffect(() => {\r\n    // This runs only once when component mounts\r\n    const randomWords = getRandomWords(WORDS_PER_SESSION);\r\n    setWords(randomWords);\r\n    const shuffledSounds = [...soundsData].sort(() => Math.random() - 0.5);\r\n    setSoundsToLearn(shuffledSounds);\r\n  }, []);\r\n\r\n  const currentWord = words[currentIndex];\r\n  const currentSound = soundsToLearn[currentIndex];\r\n\r\n  // Text-to-speech function with error handling and vibration\r\n  const speak = (text: string) => {\r\n    if (typeof window !== \"undefined\" && window.speechSynthesis) {\r\n      try {\r\n        window.speechSynthesis.cancel();\r\n        const utterance = new SpeechSynthesisUtterance(text);\r\n        utterance.lang = \"fr-FR\";\r\n        utterance.rate = playbackSpeed;\r\n        \r\n        // Add error handling\r\n        utterance.onerror = (event) => {\r\n          console.error('Speech synthesis error:', event);\r\n          // Fallback: try again once\r\n          setTimeout(() => window.speechSynthesis.speak(utterance), 100);\r\n        };\r\n        \r\n        window.speechSynthesis.speak(utterance);\r\n        setLastSpokenText(text);\r\n        \r\n        // Haptic feedback on mobile\r\n        if ('vibrate' in navigator) {\r\n          navigator.vibrate(10);\r\n        }\r\n      } catch (error) {\r\n        console.error('Failed to speak:', error);\r\n      }\r\n    }\r\n  };\r\n\r\n  // Quick replay last sound\r\n  const replayLast = () => {\r\n    if (lastSpokenText) {\r\n      speak(lastSpokenText);\r\n    }\r\n  };\r\n\r\n  // Handle speed change\r\n  const handleSpeedChange = (speed: number) => {\r\n    setSpeed(speed);\r\n    setPlaybackSpeed(speed);\r\n  };\r\n\r\n  // Reveal translation\r\n  const handleRevealTranslation = () => {\r\n    setTranslationRevealed(true);\r\n  };\r\n\r\n  // Handle \"I Got It!\" button\r\n  const handleGotIt = () => {\r\n    setCorrectCount(correctCount + 1);\r\n    if ('vibrate' in navigator) {\r\n      navigator.vibrate([50, 30, 50]); // Success pattern\r\n    }\r\n    moveToNext();\r\n  };\r\n\r\n  // Handle \"Try Again\" button\r\n  const handleTryAgain = () => {\r\n    if ('vibrate' in navigator) {\r\n      navigator.vibrate(30); // Short vibration\r\n    }\r\n    moveToNext();\r\n  };\r\n\r\n  // Move to next word or complete session\r\n  const moveToNext = () => {\r\n    const totalItems = practiceMode === 'words' ? words.length : soundsToLearn.length;\r\n    if (currentIndex < totalItems - 1) {\r\n      setCurrentIndex(currentIndex + 1);\r\n      setTranslationRevealed(false);\r\n    } else {\r\n      // Save session result\r\n      const sessionSize = practiceMode === 'words' ? WORDS_PER_SESSION : soundsToLearn.length;\r\n      savePracticeSession(correctCount, sessionSize);\r\n      setSessionComplete(true);\r\n    }\r\n  };\r\n\r\n  // Restart practice session\r\n  const handleRestart = () => {\r\n    if (practiceMode === 'words') {\r\n      const randomWords = getRandomWords(WORDS_PER_SESSION);\r\n      setWords(randomWords);\r\n    } else {\r\n      const shuffledSounds = [...soundsData].sort(() => Math.random() - 0.5);\r\n      setSoundsToLearn(shuffledSounds);\r\n    }\r\n    setCurrentIndex(0);\r\n    setCorrectCount(0);\r\n    setTranslationRevealed(false);\r\n    setSessionComplete(false);\r\n    setSessionStartTime(Date.now());\r\n  };\r\n\r\n  // Auto-play when new card appears\r\n  useEffect(() => {\r\n    if (autoPlay && !sessionComplete && currentWord) {\r\n      const timer = setTimeout(() => {\r\n        if (practiceMode === 'words') {\r\n          speak(currentWord.french);\r\n        } else if (currentSound) {\r\n          speak(currentSound.phoneticSound);\r\n        }\r\n      }, 500);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [currentIndex, autoPlay, sessionComplete, practiceMode]);\r\n\r\n  // Keyboard shortcuts\r\n  useEffect(() => {\r\n    const handleKeyPress = (event: KeyboardEvent) => {\r\n      if (sessionComplete) return;\r\n\r\n      switch (event.key.toLowerCase()) {\r\n        case ' ':\r\n          event.preventDefault();\r\n          if (practiceMode === 'words' && currentWord) {\r\n            speak(currentWord.french);\r\n          } else if (currentSound) {\r\n            speak(currentSound.phoneticSound);\r\n          }\r\n          break;\r\n        case 'enter':\r\n          event.preventDefault();\r\n          if (translationRevealed || practiceMode === 'sounds') {\r\n            handleGotIt();\r\n          }\r\n          break;\r\n        case 'r':\r\n          event.preventDefault();\r\n          if (translationRevealed || practiceMode === 'sounds') {\r\n            handleTryAgain();\r\n          }\r\n          break;\r\n        case 't':\r\n          event.preventDefault();\r\n          if (practiceMode === 'words' && !translationRevealed) {\r\n            handleRevealTranslation();\r\n          }\r\n          break;\r\n        case 'q':\r\n          event.preventDefault();\r\n          replayLast();\r\n          break;\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyPress);\r\n    return () => window.removeEventListener('keydown', handleKeyPress);\r\n  }, [sessionComplete, translationRevealed, currentIndex, practiceMode, lastSpokenText]);\r\n\r\n  // Preload TTS voices\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined' && window.speechSynthesis) {\r\n      window.speechSynthesis.getVoices();\r\n      \r\n      window.speechSynthesis.addEventListener('voiceschanged', () => {\r\n        window.speechSynthesis.getVoices();\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  // Auto-restart in continuous mode (moved outside of conditional)\r\n  useEffect(() => {\r\n    if (continuousMode && sessionComplete) {\r\n      const timer = setTimeout(() => {\r\n        handleRestart();\r\n      }, 3000);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [continuousMode, sessionComplete, handleRestart]);\r\n\r\n  // Loading state\r\n  if ((practiceMode === 'words' && words.length === 0) || \r\n      (practiceMode === 'sounds' && soundsToLearn.length === 0)) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-b from-green-50 to-blue-50 flex items-center justify-center\">\r\n        <p className=\"text-xl text-gray-600\">Loading practice session...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Session complete view\r\n  if (sessionComplete) {\r\n    const totalItems = practiceMode === 'words' ? WORDS_PER_SESSION : soundsToLearn.length;\r\n    const sessionTime = Math.floor((Date.now() - sessionStartTime) / 1000);\r\n\r\n    return (\r\n      <div className=\"min-h-screen bg-gradient-to-b from-green-50 to-blue-50 px-4 py-8 flex items-center page-transition\">\r\n        <div className=\"max-w-2xl mx-auto w-full\"\r\n>\r\n          <SessionComplete\r\n            correctCount={correctCount}\r\n            totalWords={totalItems}\r\n            sessionTime={sessionTime}\r\n            onRestart={handleRestart}\r\n            onBackHome={() => (window.location.href = \"/\")}\r\n          />\r\n          {continuousMode && (\r\n            <div className=\"mt-4 text-center text-gray-600 animate-pulse-subtle\">\r\n              <p>üîÑ Continuous mode: Next session starts in 3 seconds...</p>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Calculate totals\r\n  const totalItems = practiceMode === 'words' ? WORDS_PER_SESSION : soundsToLearn.length;\r\n\r\n  // Practice view\r\n  return (\r\n    <div className=\"min-h-screen bg-gradient-to-b from-green-50 to-blue-50 pb-20 page-transition\"\r\n>\r\n      {/* Header with Progress */}\r\n      <div className=\"sticky top-0 z-10 bg-white shadow-md px-4 py-4 transition-all duration-300\">\r\n        <div className=\"max-w-2xl mx-auto\">\r\n          <h1 className=\"text-2xl font-bold text-gray-800 mb-3 text-center\">\r\n            Practice Mode\r\n          </h1>\r\n          \r\n          {/* Mode Selector */}\r\n          <div className=\"flex justify-center mb-4\">\r\n            <PracticeModeSelector \r\n              selectedMode={practiceMode}\r\n              onModeChange={setPracticeMode}\r\n            />\r\n          </div>\r\n          \r\n          <ProgressBar current={currentIndex + 1} total={totalItems} />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Content */}\r\n      <div className=\"max-w-2xl mx-auto px-4 py-6 sm:py-8\">\r\n        {/* Controls Row */}\r\n        <div className=\"flex gap-4 flex-wrap items-center justify-between mb-6\">\r\n          <SpeedControl\r\n            currentSpeed={playbackSpeed}\r\n            onSpeedChange={handleSpeedChange}\r\n          />\r\n          \r\n          {/* Auto-play Toggle */}\r\n          <button\r\n            onClick={() => setAutoPlay(!autoPlay)}\r\n            className={`px-4 py-2 rounded-xl font-semibold transition-all duration-200 ripple ${\r\n              autoPlay\r\n                ? 'bg-green-500 text-white shadow-md'\r\n                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'\r\n            }`}\r\n          >\r\n            {autoPlay ? 'üîä Auto-play: ON' : 'üîá Auto-play: OFF'}\r\n          </button>\r\n\r\n          {/* Continuous Mode Toggle */}\r\n          <button\r\n            onClick={() => setContinuousMode(!continuousMode)}\r\n            className={`px-4 py-2 rounded-xl font-semibold transition-all duration-200 ripple ${\r\n              continuousMode\r\n                ? 'bg-blue-500 text-white shadow-md'\r\n                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'\r\n            }`}\r\n          >\r\n            {continuousMode ? 'üîÑ Continuous: ON' : '‚è∏Ô∏è Continuous: OFF'}\r\n          </button>\r\n        </div>\r\n\r\n        {/* Practice Card with key for smooth transitions */}\r\n        <div key={currentIndex}>\r\n          {practiceMode === 'words' ? (\r\n            <PracticeCard\r\n              french={currentWord.french}\r\n              english={currentWord.english}\r\n              translationRevealed={translationRevealed}\r\n              onSpeak={() => speak(currentWord.french)}\r\n              onRevealTranslation={handleRevealTranslation}\r\n              onGotIt={handleGotIt}\r\n              onTryAgain={handleTryAgain}\r\n              wordNumber={currentIndex + 1}\r\n              totalWords={totalItems}\r\n            />\r\n          ) : (\r\n            <SoundPracticeCard\r\n              soundTitle={currentSound.title}\r\n              phonetic={currentSound.phonetic}\r\n              phoneticSound={currentSound.phoneticSound}\r\n              playbackSpeed={playbackSpeed}\r\n              onGotIt={handleGotIt}\r\n              onTryAgain={handleTryAgain}\r\n            />\r\n          )}\r\n        </div>\r\n\r\n        {/* Score Display */}\r\n        <div className=\"mt-6 text-center\">\r\n          <p className=\"text-gray-700 font-semibold\">\r\n            Correct: <span className=\"text-green-600 font-bold\">{correctCount}</span> /{\" \"}\r\n            {currentIndex + 1}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Keyboard Shortcuts Help */}\r\n        <div className=\"mt-6 p-4 bg-blue-50 rounded-2xl text-sm text-gray-600\">\r\n          <p className=\"font-semibold text-center mb-2\">‚å®Ô∏è Keyboard Shortcuts</p>\r\n          <div className=\"grid grid-cols-2 gap-2 text-xs\">\r\n            <div><kbd className=\"px-2 py-1 bg-white rounded shadow\">Space</kbd> - Play sound</div>\r\n            <div><kbd className=\"px-2 py-1 bg-white rounded shadow\">Enter</kbd> - Got It!</div>\r\n            <div><kbd className=\"px-2 py-1 bg-white rounded shadow\">R</kbd> - Try Again</div>\r\n            <div><kbd className=\"px-2 py-1 bg-white rounded shadow\">T</kbd> - Show translation</div>\r\n            <div><kbd className=\"px-2 py-1 bg-white rounded shadow\">Q</kbd> - Replay last</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Floating Quick Replay Button */}\r\n      {lastSpokenText && (\r\n        <button\r\n          onClick={replayLast}\r\n          className=\"fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full shadow-2xl hover:shadow-3xl transition-all duration-200 active:scale-95 flex items-center justify-center z-50 ripple animate-pulse-subtle\"\r\n          title=\"Replay last sound (Q)\"\r\n        >\r\n          <svg className=\"w-8 h-8\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\r\n            <path fillRule=\"evenodd\" d=\"M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z\" clipRule=\"evenodd\" />\r\n          </svg>\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}"
        }
    ]
}